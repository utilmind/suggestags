!function(t){"object"==typeof module&&"object"==typeof module.exports?t(require("jquery"),window,document):t(jQuery,window,document)}(function(t,e,s,i){var a=function(t){this.selector=t,this.settings={iconRemove:"&times;",tooltipRemove:"Remove",tagLimit:-1,suggestions:[],suggestionsAction:{timeout:-1,minChars:2,minChange:-1,type:"GET"},minSuggestionWidth:"200px",defaultTagClass:"",classes:[],backgrounds:[],colors:[],whiteList:!1,prepareTag:{},afterAdd:{},afterRemove:{},addTagOnBlur:!0,clearOnEsc:!0,selectOnHover:!1,selectSimilar:!1,triggerChange:!1,noSuggestionMsg:"",highlightSuggestion:!0,showAllSuggestions:!1,keepLastOnHoverTag:!0,checkSimilar:!0,delimiters:[",",";"]},this.classes={sTagsArea:".umsg-suggestags-area",inputArea:".umsg-suggestags-input-area",focus:".umsg-focus",sTagsInput:".umsg-suggestags-input",listArea:".umsg-suggestags-list",list:".umsg-list",listItem:".umsg-list-item",itemPad:".umsg-item-pad",inputType:".umsg-select-input",tagItem:".umsg-select-tag",colBg:".umsg-col-bg",removeTag:".umsg-remove-tag",noSuggestion:".umsg-no-suggestion",waitToRemove:"wt-rmv",readyToRemove:"to-rmv"},this.selectors={sTagsArea:null,inputArea:null,sTagsInput:null,listArea:null,list:null,listGroup:null,listItem:null,itemPad:null,inputType:null},this.isRequired=!1,this.ajaxActive=!1,this.tagNames=[]};a.prototype={init:function(e,s){var i=t(this.selector);if(e&&(this.settings=t.extend(!0,{},this.settings,e)),s){if(s){if("destroy"===s){var a=i.next(this.classes.sTagsArea);return a.length&&a.remove(),void i.show()}"refresh"===s&&this.removeTag(!1)}}else{this.createHTML().setEvents();var n=this.selectors.sTagsInput;i.is(":focus")&&n.trigger("focus"),i.hide().on("focus",function(t){n.trigger("focus",t)})}this.addTags(i.val())},createHTML:function(){var e,s=this.selectors,i=this.selector,a=t(i),n=a.attr("id");return s.sTagsArea=t('<div class="'+this.classes.sTagsArea.substr(1)+'"></div>').insertAfter(i),s.inputArea=t('<div class="'+this.classes.inputArea.substr(1)+'"></div>').appendTo(s.sTagsArea),s.sTagsInput=t('<div contenteditable="plaintext-only" class="'+this.classes.sTagsInput.substr(1)+'"'+((e=a.attr("placeholder"))?' placeholder="'+e+'"':"")+((e=a.attr("spellcheck"))?' spellcheck="'+e+'"':"")+"></div>").appendTo(s.inputArea),a.attr("required")&&(a.removeAttr("required"),this.isRequired=!0,this.updateIsRequired()),s.listArea=t('<div class="'+this.classes.listArea.substr(1)+'"></div>').appendTo(s.sTagsArea).css("min-width",this.settings.minSuggestionWidth),s.list=t('<ul class="'+this.classes.list.substr(1)+'"></ul>').appendTo(s.listArea),this.updateSuggestionList(),n&&t('label[for="'+n+'"]').on("click",function(){setTimeout(function(){s.sTagsInput.trigger("focus")})}),this},updateIsRequired:function(){var t=this.selectors.sTagsInput;this.isRequired&&(this.tagNames.length?t.removeAttr("required"):t.attr("required","required"))},updateSuggestionList:function(){return t(this.selectors.list).html(""),t(this.createList()).appendTo(this.selectors.list),this},setEvents:function(){var e=t(this.selector),s=t(this.selectors.inputArea),i=e.attr("style");i&&s.attr("style",i),s.addClass(e.attr("class")),this.setTagEvents().setSuggestionsEvents().setRemoveEvent()},setTagEvents:function(){var i=this,a=i.settings,n=i.selectors,o=i.classes,r=n.listArea,g=n.sTagsInput,u=function(e){var s=g.text().trim();e&&t.each(i.settings.delimiters,function(t,e){s=s.replace(e,"").trim()}),g.text(""),i.addTag(i.getValue(s)),i.settings.showAllSuggestions&&i.suggestWhiteList("",0,1)};return g.on("focus",function(){var e=t(this).parent();a.showAllSuggestions&&setTimeout(function(){i.suggestWhiteList("",0,1)}),e.closest(o.inputArea).addClass(o.focus.substr(1))}).on("blur",function(){var e=t(this);e.closest(o.inputArea).removeClass(o.focus.substr(1)),e.text()?a.addTagOnBlur&&u():r.hide()}).on("keydown",function(e){var s=t(this),a=e.keyCode;8!==a||s.text()?i.isLimitReached()&&(32===a||48<a&&!(112<=a&&123>=a))?e.preventDefault():s.removeClass(o.waitToRemove).removeClass(o.readyToRemove):s.addClass(s.hasClass(o.waitToRemove)?o.readyToRemove:o.waitToRemove)}).on("keyup",function(e){var n=t(this),g=n.text(),l=e.key,c=e.keyCode;if(l?"Shift"===l&&","===g.substr(-1)&&(l=","):13===c?l="Enter":27===c?l="Escape":188===c&&(l=","),"Escape"===l)return r.hide(),void(a.clearOnEsc&&n.text(""));var h=-1!==t.inArray(l,a.delimiters),f="Enter"===l;if(h||f)f&&""===g?n.closest("form").submit():u(h);else if(8!==c||g){if((a.suggestions.length||i.isSuggestAction())&&(g||a.showAllSuggestions)){var d;if(40===c||38===c||39===c&&(d=s.getSelection())&&g.length===d.focusOffset){var m=38!==c,v=t(i.selectors.listArea).find(o.listItem+".sel:visible"),p=function(t){t.length&&(isSelected=1,i.setInputText(t.addClass("sel").text()))};v.length?39===c?u(i.selectors.sTagsInput):v.each(function(){t(this).removeClass("sel"),p(t(this)[m?"nextAll":"prevAll"](o.listItem+":visible:first"))}):p(t(i.selectors.listArea).find(o.listItem+":visible:"+(m?"first":"last")))}else if(i.isSuggestAction()&&!i.ajaxActive){var T=i.settings.suggestionsAction.minChars,A=i.settings.suggestionsAction.minChange,I=i.selectors.sTagsInput.data("last-search");g.length>=T&&(-1===A||!I||100*i.similarity(I,g)<=A)&&(i.selectors.sTagsInput.data("last-search",g),i.ajaxActive=!0,i.processAjaxSuggestion(g,c))}else i.suggestWhiteList(g,c)}}else(i.isLimitReached()||n.hasClass(o.readyToRemove))&&i.removeTagByItem(n.closest(o.inputArea).find(o.tagItem+":last"),!1),r.hide(),a.showAllSuggestions&&i.suggestWhiteList("",0,1)}).on("keypress",function(t){if(13===t.keyCode)return!1}).on("paste",function(t){var s=(t.originalEvent.clipboardData||e.clipboardData).getData("text");s&&(t.preventDefault(),i.addTags(s))}),t(n.sTagsArea).on("click",function(){g.is(":focus")||g.trigger("focus")}),i},setSuggestionsEvents:function(){var e=this,s=e.settings,i=e.selectors,a=e.classes;return t(i.listArea).find(a.listItem).on("mouseenter",function(){t(i.listArea).find(a.listItem).removeClass("sel"),t(this).addClass("sel"),s.selectOnHover&&e.setInputText(t(this).text())}).on("mouseleave",function(){t(this).removeClass("sel"),s.selectOnHover&&!s.keepLastOnHoverTag&&i.sTagsInput.text("")}),t(i.listArea).find(a.listItem).on("mousedown",function(t){t.preventDefault()}).on("click",function(){e.addTag(t(this).data("val")),i.sTagsInput.text("").trigger("focus")}),e},isLimitReached:function(){var t=this.settings.tagLimit;return 0<t&&this.tagNames.length>=t},isSuggestAction:function(){return this.settings.suggestionsAction&&this.settings.suggestionsAction.url},getTag:function(e){if(this.settings.suggestions.length){var s=e;t.each(this.settings.suggestions,function(t,i){return"object"==typeof i&&i.value===e?(s=i.tag,!1):i!==e&&void 0}),e=s}return e},getValue:function(e){if(this.settings.suggestions.length){var s=e,i=e.toLowerCase();return t.each(this.settings.suggestions,function(t,e){return"object"==typeof e&&i===e.tag.toLowerCase()?(s=e.value,!1):i!==e.toLowerCase()&&void 0}),s}return e},processAjaxSuggestion:function(s,a){var n,o,r=this,g=r.settings,u={existingTags:r.tagNames,existing:g.suggestions,term:s},l={url:(n=g.suggestionsAction.url,o="",e!==i&&(o=e.location.protocol+"//"+e.location.host),function(t){return!!new RegExp("^(?:[a-z]+:)?//","i").test(t)}(n)?o=n:o+="/"+n.replace(/^\/|\/$/g,""),o)};"GET"===g.suggestionsAction.type?l.url=l.url+"?"+t.param(u):(l.type=g.suggestionsAction.type,l.data=u),-1!==g.suggestionsAction.timeout&&(l.timeout=1e3*g.suggestionsAction.timeout),"function"==typeof g.suggestionsAction.beforeSend&&(l.beforeSend=g.suggestionsAction.beforeSend),l.success=function(e){e&&e.suggestions&&(g.suggestions=t.merge(g.suggestions,e.suggestions),g.suggestions=r.unique(g.suggestions),r.updateSuggestionList().setSuggestionsEvents().suggestWhiteList(s,a)),"function"==typeof g.suggestionsAction.success&&g.suggestionsAction.success(e)},"function"==typeof g.suggestionsAction.error&&(l.error=g.suggestionsAction.error),l.complete=function(t){"function"==typeof g.suggestionsAction.complete&&g.suggestionsAction.complete(t),r.ajaxActive=!1},t.ajax(l)},setInputText:function(t){var i,a,n,o,r=this.selectors.sTagsInput;r.text(t),i=r.text().length,a=r[0],n=s.createRange(),o=e.getSelection(),n.setStart(a.childNodes[0],i),n.collapse(!0),o.removeAllRanges(),o.addRange(n)},suggestWhiteList:function(e,s,i){var a,n=this,o=n.settings,r=n.selectors,g=n.classes,u=e.toLowerCase(),l=t(r.listArea);t(r.sTagsArea);l.find(g.noSuggestion).hide();var c=l.find(this.classes.list);if(c.find(g.listItem).each(function(){var e=t(this),s=e.data("val");(i||~e.text().toLowerCase().indexOf(u))&&-1===t.inArray(s,n.tagNames)?(e.attr("data-show",1),a=1):e.removeAttr("data-show"),e.hide()}),a){var h=c.find(g.listItem+"[data-show]");h.sort(function(s,i){s=t(s).text(),i=t(i).text();var a=e.toLowerCase(),n=e.length,o=s.substr(0,n).toLowerCase()===a,r=i.substr(0,n).toLowerCase()===a;if(o){if(!r)return-1}else if(r)return 1;return s.localeCompare(i)}).appendTo(c),o.highlightSuggestion&&c.find(g.listItem).each(function(){var s=t(this);s.html(s.text().replace(new RegExp("("+e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","gi"),"<b>$1</b>"))}),h.each(function(){t(this).show()});var f=l.find(g.listItem+":visible"),d=function(t,e,s){return!!n.settings.checkSimilar&&!!(100*n.similarity(t,e)>=s)};1===f.length&&8!==s?o.selectSimilar&&(o.whiteList&&d(e.toLowerCase(),f.text().toLowerCase(),40)||d(e.toLowerCase(),f.text().toLowerCase(),60))&&(f.addClass("sel"),n.setInputText(f.text())):f.removeClass("sel");var m=r.inputArea,v=m.position().left,p=r.sTagsInput.position().left;l.css({left:v+p,width:m.width()-p+3}),l.show()}else e&&o.noSuggestionMsg?(l.find(g.listItem).hide(),l.find(g.noSuggestion).show()):l.hide();return n},setRemoveEvent:function(){var e=this;return e.selectors.inputArea.find(e.classes.removeTag).on("click",function(s){s.stopImmediatePropagation();var i=t(this).closest(e.classes.tagItem);e.removeTagByItem(i,!1),e.selectors.sTagsInput.trigger("focus")}),e},createList:function(){var e=this,s=e.settings,i="";return t.each(s.suggestions,function(t,s){var a="",n="";"object"==typeof s?(a=s.value,n=s.tag):(a=s,n=s),i+='<li class="'+e.classes.listItem.substr(1)+'" data-val="'+a+'">'+n+"</li>"}),s.noSuggestionMsg&&(i+='<li class="'+e.classes.noSuggestion.substr(1)+'">'+s.noSuggestionMsg+"</li>"),i},addTag:function(e){if(e){var s=this.settings,i=this.selectors.sTagsInput,a=i.attr("placeholder");a&&i.data("placeholder",a).removeAttr("placeholder"),"function"==typeof s.prepareTag&&(e=s.prepareTag(e));var n=t('<span class="'+this.classes.tagItem.substr(1)+'" data-val="'+e+'">'+this.getTag(e)+' <span class="'+this.classes.removeTag.substr(1)+'"'+(s.tooltipRemove?' title="'+s.tooltipRemove+'"':"")+">"+s.iconRemove+"</span></span>").insertBefore(i);if(s.defaultTagClass&&n.addClass(s.defaultTagClass),-1!==s.tagLimit&&0<s.tagLimit&&this.isLimitReached())return this.removeItem(n,1).flashItem(e),!1;var o=this.getItemKey(e);if(s.whiteList&&-1===o)return this.removeItem(n,1).flashItem(e),!1;this.isPresent(e)?this.removeItem(n,1).flashItem(e):(this.customStylings(n,o).tagNames.push(e),this.setRemoveEvent().updateInputValue(),s.afterAdd&&"function"==typeof s.afterAdd&&s.afterAdd(e)),t(this.selector).trigger("suggestags.add",[e]),t(this.selector).trigger("suggestags.change"),s.triggerChange&&t(this.selector).trigger("change"),t(this.selectors.listArea).find(this.classes.listItem).removeClass("sel"),t(this.selectors.listArea).hide(),i.removeClass(this.classes.readyToRemove)}},addTags:function(e){var s=this;(e=e.split(",")).length&&t.each(e,function(t,e){s.addTag(e.trim())})},removeTag:function(e,s){var i=this,a=function(e){return t(i.selectors.inputArea).find('[data-val="'+e+'"]')};i.tagNames.length&&(e?i.removeTagByItem(a,s):(t.each(i.tagNames,function(t,e){i.removeItem(a(e),s)}),i.tagNames=[])),i.updateInputValue()},removeTagByItem:function(e,s){var i=this.settings,a=this.selectors.sTagsInput;if(this.tagNames.splice(t(e).index(),1),this.removeItem(e,s).updateInputValue(),t(this.selector).trigger("suggestags.remove",[t(e).attr("data-val")]).trigger("suggestags.change"),i.triggerChange&&t(this.selector).trigger("change"),"function"==typeof i.afterRemove&&i.afterRemove(t(e).attr("data-val")),a.removeClass(this.classes.readyToRemove),!this.tagNames.length){var n=a.data("placeholder");n&&a.attr("placeholder",n)}},removeItem:function(e,s){return(e=t(e)).length&&(s?(t(e).addClass("disabled"),setTimeout(function(){t(e).fadeOut(),setTimeout(function(){t(e).remove()},500)},200)):t(e).remove()),this},flashItem:function(e){var s=!1;return e=e.toLowerCase(),t(this.selectors.sTagsArea).find(this.classes.tagItem).each(function(){var i=t(this).attr("data-val").trim();if(e===i.toLowerCase())return s=t(this),!1}),s&&(s.addClass("flash"),setTimeout(function(){s.removeClass("flash")},1500)),this},getItemKey:function(e){var s=-1;if(this.settings.suggestions.length){var i=e.toLowerCase();t.each(this.settings.suggestions,function(t,e){if("object"==typeof e){if(e.value.toLowerCase()===i)return s=t,!1}else if(e.toLowerCase()===i)return s=t,!1})}return s},isPresent:function(e){var s=0;return t.each(this.tagNames,function(t,i){if(e.toLowerCase()===i.toLowerCase())return s=1,!1}),s},customStylings:function(e,s){var i=this.settings,a=t(e),n=!1;return i.classes[s]&&(n=!0,a.addClass(i.classes[s])),i.backgrounds[s]&&(n=!0,a.css("background",i.backgrounds[s])),i.colors[s]&&(n=!0,a.css("color",i.colors[s])),n||a.addClass(this.classes.colBg.substr(1)),this},updateInputValue:function(){this.updateIsRequired(),t(this.selector).val(this.tagNames.join(","))},refresh:function(){this._init(!1,"refresh")},destroy:function(){this._init(!1,"destroy")},similarity:function(t,e){var s=t,i=e;t.length<e.length&&(s=e,i=t);var a=s.length;return 0===a?1:(a-function(t,e){t=t.toLowerCase(),e=e.toLowerCase();for(var s=0,i=[];s<=t.length;++s){var a,n=s;for(a=0;a<=e.length;++a)if(0===s)i[a]=a;else if(0<a){var o=i[a-1];t.charAt(s-1)!==e.charAt(a-1)&&(o=Math.min(Math.min(o,n),i[a])+1),i[a-1]=n,n=o}0<s&&(i[e.length]=n)}return i[e.length]}(s,i))/parseFloat(a)}},t.fn.umSuggestags=function(t,e){return this.each(function(){if(t&&"object"!=typeof t&&(e=t,t=!1),!this.suggestTags){if(e)return!1;this.suggestTags=new a(this)}this.suggestTags.init(t,e)})}});