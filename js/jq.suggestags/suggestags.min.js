var AmsifySuggestags;!function(s){"object"==typeof module&&"object"==typeof module.exports?s(require("jquery"),window,document):s(jQuery,window,document)}(function(s,t,e,i){(AmsifySuggestags=function(s){this.selector=s,this.settings={iconRemove:"&times;",tooltipRemove:"Remove",tagLimit:-1,suggestions:[],suggestionsAction:{timeout:-1,minChars:2,minChange:-1,type:"GET"},minSuggestionWidth:"200px",defaultTagClass:"",classes:[],backgrounds:[],colors:[],whiteList:!1,prepareTag:{},afterAdd:{},afterRemove:{},addTagOnBlur:!0,clearOnEsc:!0,selectOnHover:!1,selectSimilar:!1,triggerChange:!1,noSuggestionMsg:"",highlightSuggestion:!0,showAllSuggestions:!1,keepLastOnHoverTag:!0,checkSimilar:!0,delimiters:[]},this.classes={sTagsArea:".amsify-suggestags-area",inputArea:".amsify-suggestags-input-area",focus:".amsify-focus",sTagsInput:".amsify-suggestags-input",listArea:".amsify-suggestags-list",list:".amsify-list",listItem:".amsify-list-item",itemPad:".amsify-item-pad",inputType:".amsify-select-input",tagItem:".amsify-select-tag",colBg:".col-bg",removeTag:".amsify-remove-tag",readyToRemove:".ready-to-remove",noSuggestion:".amsify-no-suggestion"},this.selectors={sTagsArea:null,inputArea:null,sTagsInput:null,listArea:null,list:null,listGroup:null,listItem:null,itemPad:null,inputType:null},this.isRequired=!1,this.ajaxActive=!1,this.tagNames=[]}).prototype={init:function(t,e){var i=this,a=s(i.selector),n=a.val().split(",");if(t&&(i.settings=s.extend(!0,{},i.settings,t)),e){if(e){if("destroy"===e){var o=a.next(i.classes.sTagsArea);return o.length&&o.remove(),void a.show()}"refresh"===e&&i.removeTag(!1)}}else i.createHTML(),i.setEvents(),a.hide();n.length&&s.each(n,function(t,e){i.addTag(s.trim(e))})},createHTML:function(){var t,e=this.selectors,i=this.selector,a=s(i),n=a.attr("id");e.sTagsArea=s('<div class="'+this.classes.sTagsArea.substr(1)+'"></div>').insertAfter(i),e.inputArea=s('<div class="'+this.classes.inputArea.substr(1)+'"></div>').appendTo(e.sTagsArea),e.sTagsInput=s('<div contenteditable="plaintext-only" class="'+this.classes.sTagsInput.substr(1)+'"'+((t=a.attr("placeholder"))?' placeholder="'+t+'"':"")+((t=a.attr("spellcheck"))?' spellcheck="'+t+'"':"")+"></div>").appendTo(e.inputArea),a.attr("required")&&(a.removeAttr("required"),this.isRequired=!0,this.updateIsRequired()),e.listArea=s('<div class="'+this.classes.listArea.substr(1)+'"></div>').appendTo(e.sTagsArea).css("min-width",this.settings.minSuggestionWidth),e.list=s('<ul class="'+this.classes.list.substr(1)+'"></ul>').appendTo(e.listArea),this.updateSuggestionList(),n&&s('label[for="'+n+'"]').click(function(){setTimeout(function(){s(e.sTagsInput).focus()},0)})},updateIsRequired:function(){var t=s(this.selectors.sTagsInput);this.isRequired&&(this.tagNames.length?t.removeAttr("required"):t.attr("required","required"))},updateSuggestionList:function(){s(this.selectors.list).html(""),s(this.createList()).appendTo(this.selectors.list)},setEvents:function(){s(this.selectors.inputArea).attr("style",s(this.selector).attr("style")).addClass(s(this.selector).attr("class")),this.setTagEvents(),this.setSuggestionsEvents(),this.setRemoveEvent()},setTagEvents:function(){var t=this,e=t.settings,i=t.selectors,a=s(i.listArea),n=s(i.sTagsInput);appendTag=function(t,e,i){var a=s.trim(e.text().replace(/,/g,""));i&&s.each(t.settings.delimiters,function(t,e){a=s.trim(a.replace(e,""))}),e.text(""),t.addTag(t.getValue(a)),t.settings.showAllSuggestions&&t.suggestWhiteList("",0,1)},n.focus(function(){var i=s(this).parent();e.showAllSuggestions&&t.suggestWhiteList("",0,1),i.closest(t.classes.inputArea).addClass(t.classes.focus.substr(1))}).blur(function(){var i=s(this);i.closest(t.classes.inputArea).removeClass(t.classes.focus.substr(1)),i.text()?e.addTagOnBlur&&appendTag(t,i):a.hide()}).keydown(function(s){var e=s.keyCode;t.isLimitReached()&&48<e&&!(e>=112&&e<=123)&&s.preventDefault()}).keyup(function(i){var n=s(this),o=n.text(),r=i.key;if(r?"Shift"===r&&","===o.substr(-1)&&(r=","):13===i.keyCode?r="Enter":27===i.keyCode?r="Escape":188===i.keyCode&&(r=","),"Escape"===r)return a.hide(),void(e.clearOnEsc&&n.text(""));var g=e.delimiters&&-1!==s.inArray(r,e.delimiters),l="Enter"===r;if(","===r||l||g)l&&""===o?n.closest("form").submit():appendTag(t,n,g);else if(8!==i.keyCode||n.text())(e.suggestions.length||t.isSuggestAction())&&(n.text()||e.showAllSuggestions)&&(n.removeClass(t.classes.readyToRemove.substr(1)),t.processWhiteList(i.keyCode,n.text()));else{var u=t.classes.readyToRemove.substr(1);t.isLimitReached()||n.hasClass(u)?t.removeTagByItem(n.closest(t.classes.inputArea).find(t.classes.tagItem+":last"),!1):n.addClass(u),a.hide(),e.showAllSuggestions&&t.suggestWhiteList("",0,1)}}).keypress(function(s){if(13===s.keyCode)return!1}),s(i.sTagsArea).click(function(){n.is(":focus")||n.focus()})},setSuggestionsEvents:function(){var t=this,e=t.settings,i=t.selectors;s(i.listArea).find(t.classes.listItem).hover(function(){s(i.listArea).find(t.classes.listItem).removeClass("active"),s(this).addClass("active"),e.selectOnHover&&t.setInputText(s(this).text())},function(){s(this).removeClass("active"),e.selectOnHover&&!e.keepLastOnHoverTag&&s(i.sTagsInput).text("")}),s(i.listArea).find(t.classes.listItem).mousedown(function(s){s.preventDefault()}).click(function(){t.addTag(s(this).data("val")),s(i.sTagsInput).text("").focus()})},isLimitReached:function(){var s=this.settings.tagLimit;return 0<s&&this.tagNames.length>=s},isSuggestAction:function(){return this.settings.suggestionsAction&&this.settings.suggestionsAction.url},getTag:function(t){if(this.settings.suggestions.length){var e=t;s.each(this.settings.suggestions,function(s,i){return"object"==typeof i&&i.value===t?(e=i.tag,!1):i!==t&&void 0}),t=e}return t},getValue:function(t){if(this.settings.suggestions.length){var e=t,i=t.toLowerCase();return s.each(this.settings.suggestions,function(s,t){return"object"==typeof t&&t.tag.toLowerCase()===i?(e=t.value,!1):t.toLowerCase()!==i&&void 0}),e}return t},processAjaxSuggestion:function(e,a){var n,o,r=this,g=r.settings,l={existingTags:r.tagNames,existing:g.suggestions,term:e},u=(g.suggestionsAction.callbacks,{url:(n=g.suggestionsAction.url,o="",t!==i&&(o=t.location.protocol+"//"+t.location.host),function(s){return!!new RegExp("^(?:[a-z]+:)?//","i").test(s)}(n)?o=n:o+="/"+n.replace(/^\/|\/$/g,""),o)});"GET"===g.suggestionsAction.type?u.url=u.url+"?"+s.param(l):(u.type=g.suggestionsAction.type,u.data=l),-1!==g.suggestionsAction.timeout&&(u.timeout=1e3*g.suggestionsAction.timeout),g.suggestionsAction.beforeSend!==i&&"function"==typeof g.suggestionsAction.beforeSend&&(u.beforeSend=g.suggestionsAction.beforeSend),u.success=function(t){t&&t.suggestions&&(g.suggestions=s.merge(g.suggestions,t.suggestions),g.suggestions=r.unique(g.suggestions),r.updateSuggestionList(),r.setSuggestionsEvents(),r.suggestWhiteList(e,a)),g.suggestionsAction.success!==i&&"function"==typeof g.suggestionsAction.success&&g.suggestionsAction.success(t)},g.suggestionsAction.error!==i&&"function"==typeof g.suggestionsAction.error&&(u.error=g.suggestionsAction.error),u.complete=function(s){g.suggestionsAction.complete!==i&&"function"==typeof g.suggestionsAction.complete&&g.suggestionsAction.complete(s),r.ajaxActive=!1},s.ajax(u)},processWhiteList:function(s,t){if(40===s||38===s){var e=40===s?"down":"up";this.upDownSuggestion(t,e)}else if(this.isSuggestAction()&&!this.ajaxActive){var i=this.settings.suggestionsAction.minChars,a=this.settings.suggestionsAction.minChange,n=this.selectors.sTagsInput.attr("last-search");t.length>=i&&(-1===a||!n||100*this.similarity(n,t)<=a)&&(this.selectors.sTagsInput.attr("last-search",t),this.ajaxActive=!0,this.processAjaxSuggestion(t,s))}else this.suggestWhiteList(t,s)},upDownSuggestion:function(t,e){var i=this,a=0;s(i.selectors.sTagsInput);if(s(i.selectors.listArea).find(i.classes.listItem+":visible").each(function(){var t=s(this);if(t.hasClass("active"))return t.removeClass("active"),(t="up"===e?t.prevAll(i.classes.listItem+":visible:first"):t.nextAll(i.classes.listItem+":visible:first")).length&&(a=1,t.addClass("active"),i.setInputText(t.text())),!1}),!a){var n="down"===e?"first":"last",o=s(i.selectors.listArea).find(i.classes.listItem+":visible:"+n);o.length&&(o.addClass("active"),i.setInputText(o.text()))}},setInputText:function(i){var a,n,o,r,g=s(this.selectors.sTagsInput);g.text(i),a=g.text().length,n=g[0],o=e.createRange(),r=t.getSelection(),o.setStart(n.childNodes[0],a),o.collapse(!0),r.removeAllRanges(),r.addRange(o)},suggestWhiteList:function(t,e,i){var a=this,n=a.settings,o=0,r=t.toLowerCase(),g=s(a.selectors.listArea);s(a.selectors.sTagsArea);g.find(a.classes.noSuggestion).hide();var l=g.find(this.classes.list);if(l.find(a.classes.listItem).each(function(){var e=s(this),n=e.data("val");s.isNumeric(n)&&(n=-1===t.indexOf(".")?parseInt(n):parseFloat(n)),(i||~e.text().toLowerCase().indexOf(r))&&-1===s.inArray(n,a.tagNames)?(e.attr("data-show",1),o=1):e.removeAttr("data-show"),e.hide()}),o){var u=l.find(this.classes.listItem+"[data-show]");u.sort(function(e,i){e=s(e).text(),i=s(i).text();var a=t.toLowerCase(),n=t.length,o=e.substr(0,n).toLowerCase()===a,r=i.substr(0,n).toLowerCase()===a;if(o){if(!r)return-1}else if(r)return 1;return e.localeCompare(i)}).appendTo(l),n.highlightSuggestion&&l.find(a.classes.listItem).each(function(){var e=s(this);e.html(e.text().replace(new RegExp("("+t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","gi"),"<b>$1</b>"))}),u.each(function(){s(this).show()});var c=g.find(a.classes.listItem+":visible"),h=function(s,t,e,i){return!!s.settings.checkSimilar&&!!(100*s.similarity(t,e)>=i)};1===c.length&&8!==e?n.selectSimilar&&(n.whiteList&&h(a,t.toLowerCase(),c.text().toLowerCase(),40)||h(a,t.toLowerCase(),c.text().toLowerCase(),60))&&(c.addClass("active"),a.setInputText(c.text())):c.removeClass("active");var f=s(a.selectors.inputArea),d=f.position().left,m=s(a.selectors.sTagsInput).position().left;g.css({left:d+m,width:f.width()-m+3}),g.show()}else t&&n.noSuggestionMsg?(g.find(a.classes.listItem).hide(),g.find(a.classes.noSuggestion).show()):g.hide()},setRemoveEvent:function(){var t=this;s(t.selectors.sTagsInput);s(t.selectors.inputArea).find(t.classes.removeTag).click(function(e){e.stopImmediatePropagation();var i=s(this).closest(t.classes.tagItem);t.removeTagByItem(i,!1),s(t.selectors.sTagsInput).focus()})},createList:function(){var t=this,e=t.settings,i="";return s.each(e.suggestions,function(s,e){var a="",n="";"object"==typeof e?(a=e.value,n=e.tag):(a=e,n=e),i+='<li class="'+t.classes.listItem.substr(1)+'" data-val="'+a+'">'+n+"</li>"}),e.noSuggestionMsg&&(i+='<li class="'+t.classes.noSuggestion.substr(1)+'">'+e.noSuggestionMsg+"</li>"),i},addTag:function(t){if(t){var e=this.settings,i=s(this.selectors.sTagsInput),a=i.attr("placeholder");a&&i.data("placeholder",a).removeAttr("placeholder"),e.prepareTag&&"function"==typeof e.prepareTag&&(t=e.prepareTag(t));var n=s('<span class="'+this.classes.tagItem.substr(1)+'" data-val="'+t+'">'+this.getTag(t)+' <span class="'+this.classes.removeTag.substr(1)+'"'+(e.tooltipRemove?' title="'+e.tooltipRemove+'"':"")+">"+e.iconRemove+"</span></span>").insertBefore(i);if(e.defaultTagClass&&n.addClass(e.defaultTagClass),-1!==e.tagLimit&&0<e.tagLimit&&this.isLimitReached())return this.removeItem(n,1),this.flashItem(t),!1;var o=this.getItemKey(t);if(e.whiteList&&-1===o)return this.removeItem(n,1),this.flashItem(t),!1;if(this.isPresent(t))this.removeItem(n,1),this.flashItem(t);else{this.customStylings(n,o);var r=t;s.isNumeric(r)&&(r=-1===t.indexOf(".")?parseInt(r):parseFloat(r)),this.tagNames.push(r),this.setRemoveEvent(),this.updateInputValue(),e.afterAdd&&"function"==typeof e.afterAdd&&e.afterAdd(t)}s(this.selector).trigger("suggestags.add",[t]),s(this.selector).trigger("suggestags.change"),e.triggerChange&&s(this.selector).trigger("change"),s(this.selectors.listArea).find(this.classes.listItem).removeClass("active"),s(this.selectors.listArea).hide(),i.removeClass(this.classes.readyToRemove.substr(1))}},removeTag:function(t,e){var i=this,a=function(t){return s(i.selectors.inputArea).find('[data-val="'+t+'"]')};i.tagNames.length&&(t?i.removeTagByItem(a,e):(s.each(i.tagNames,function(s,t){i.removeItem(a(t),e)}),i.tagNames=[])),i.updateInputValue()},removeTagByItem:function(t,e){var i=this.settings,a=s(this.selectors.sTagsInput);if(this.tagNames.splice(s(t).index(),1),this.removeItem(t,e),this.updateInputValue(),s(this.selector).trigger("suggestags.remove",[s(t).attr("data-val")]).trigger("suggestags.change"),i.triggerChange&&s(this.selector).trigger("change"),"function"===i.afterRemove&&(i.afterRemove,1)&&i.afterRemove(s(t).attr("data-val")),a.removeClass(this.classes.readyToRemove.substr(1)),!this.tagNames.length){var n=a.data("placeholder");n&&a.attr("placeholder",n)}},removeItem:function(t,e){(t=s(t)).length&&(e?(s(t).addClass("disabled"),setTimeout(function(){s(t).slideUp(),setTimeout(function(){s(t).remove()},500)},500)):s(t).remove())},flashItem:function(t){var e=!1;t=t.toLowerCase(),s(this.selectors.sTagsArea).find(this.classes.tagItem).each(function(){var i=s.trim(s(this).attr("data-val"));if(t===i.toLowerCase())return e=s(this),!1}),e&&(e.addClass("flash"),setTimeout(function(){e.removeClass("flash")},1500))},getItemKey:function(t){var e=-1;if(this.settings.suggestions.length){var i=t.toLowerCase();s.each(this.settings.suggestions,function(s,t){if("object"==typeof t){if(t.value.toLowerCase()===i)return e=s,!1}else if(t.toLowerCase()===i)return e=s,!1})}return e},isPresent:function(t){var e=0;return s.each(this.tagNames,function(s,i){if(t.toLowerCase()===i.toLowerCase())return e=1,!1}),e},customStylings:function(t,e){var i=this.settings,a=s(t),n=!1;i.classes[e]&&(n=!0,a.addClass(i.classes[e])),i.backgrounds[e]&&(n=!0,a.css("background",i.backgrounds[e])),i.colors[e]&&(n=!0,a.css("color",i.colors[e])),n||a.addClass(this.classes.colBg.substr(1))},updateInputValue:function(){this.updateIsRequired(),s(this.selector).val(this.tagNames.join(","))},refresh:function(){this._init(!1,"refresh")},destroy:function(){this._init(!1,"destroy")},similarity:function(s,t){var e=s,i=t;s.length<t.length&&(e=t,i=s);var a=e.length;return 0===a?1:(a-function(s,t){s=s.toLowerCase(),t=t.toLowerCase();var e,i=[];for(e=0;e<=s.length;++e){var a,n=e;for(a=0;a<=t.length;++a)if(0===e)i[a]=a;else if(0<a){var o=i[a-1];s.charAt(e-1)!=t.charAt(a-1)&&(o=Math.min(Math.min(o,n),i[a])+1),i[a-1]=n,n=o}0<e&&(i[t.length]=n)}return i[t.length]}(e,i))/parseFloat(a)}},s.fn.amsifySuggestags=function(s,t){return this.each(function(){if(s&&"object"!=typeof s&&(t=s,s=!1),void 0===this.suggestTags){if(t)return!1;this.suggestTags=new AmsifySuggestags(this)}this.suggestTags.init(s,t)})}});